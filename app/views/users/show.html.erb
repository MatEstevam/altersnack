<div class="container">
  <% if @user.photo.attached? %>
    <%= cl_image_tag current_user.photo.key, height: 300, width: 300, crop: :thumb %>
  <% else %>
    <%= image_tag 'default-foto.jpg', height: 300, width: 300, crop: :thumb %>
  <% end %>

  <% if @user.restaurant %>
    <h1>Restaurant Profile</h1>
    <div id="restaurant-profile">
      <h2><strong>Restaurant Name:</strong> <%= @user.name %></h2>
      <p><strong>Location:</strong> <%= @user.address %></p>

      <%= link_to 'Edit', edit_user_registration_path(@user), class: 'btn btn-warning mb-2' %>
      <%= link_to "Back", root_path, class: 'btn btn-secondary mb-2' %>
    </div>

    <h2 class="mt-4">Sales Made</h2>
    <% @user.products.each do |product| %>
      <% product.orders.group_by { |order| order.created_at.to_i }.each do |timestamp, orders| %>
        <h3>Order placed on: <%= l(Time.at(timestamp), format: :short) %></h3>
        <% if orders.first&.cart&.cart_items&.first&.product&.user %>
          <h4>
            <%= link_to orders.first.cart.cart_items.first.product.user.name, user_path(orders.first.cart.cart_items.first.product.user) %>
          </h4>
        <% end %>
        <table class="table table-responsive">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Product Total</th>
              <th>Customer</th>
            </tr>
          </thead>
          <tbody>
            <% orders.each do |order| %>
              <% order.cart.cart_items.each do |cart_item| %>
                <% if cart_item.product.present? %>
                  <tr>
                    <td><%= cart_item.product.name %></td>
                    <td><%= cart_item.quantity %></td>
                    <td><%= number_to_currency(cart_item.product.price) %></td>
                    <td><%= number_to_currency(cart_item.product.price * cart_item.quantity) %></td>
                    <td><%= link_to order.user.name, user_path(order.user) %></td>
                  </tr>
                <% end %>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <% if orders.any? && orders.first.cart.cart_items&.first&.product&.user %>
              <tr>
                <td colspan="3">Delivery Fee:</td>
                <td colspan="2"><%= number_to_currency(orders.first.cart.cart_items.first.product.user.delivery_fee || 0) %></td>
              </tr>
              <tr>
                <td colspan="3"><strong>Grand Total:</strong></td>
                <td colspan="2"><strong><%= number_to_currency(orders.sum { |o| o.cart.cart_items.sum { |item| item.product.price * item.quantity } } + (orders.first.cart.cart_items.first.product.user.delivery_fee || 0)) %></strong></td>
              </tr>
            <% end %>
          </tfoot>
        </table>
      <% end %>
    <% end %>
  <% else %>
    <h1>User Profile</h1>
    <div id="user-profile">
      <h2><strong>Name:</strong> <%= @user.name %></h2>
      <p><strong>Email:</strong> <%= @user.email %></p>

      <%= link_to 'Edit', edit_user_registration_path(@user), class: 'btn btn-warning mb-2' %>
      <%= link_to "Back", root_path, class: 'btn btn-secondary mb-2' %>
    </div>

    <h2 class="mt-4">Purchases Made</h2>
    <% @user.orders.group_by { |order| order.created_at.to_i }.each do |timestamp, orders| %>
      <h3>Order placed on: <%= l(Time.at(timestamp), format: :short) %></h3>
      <% if orders.first&.cart&.cart_items&.first&.product&.user %>
        <h4>
          <%= link_to orders.first.cart.cart_items.first.product.user.name, user_path(orders.first.cart.cart_items.first.product.user) %>
        </h4>
      <% end %>
      <table class="table table-responsive">
        <thead>
          <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Product Total</th>
          </tr>
        </thead>
        <tbody>
          <% orders.each do |order| %>
            <% order.cart.cart_items.each do |cart_item| %>
              <% if cart_item.product.present? %>
                <tr>
                  <td><%= cart_item.product.name %></td>
                  <td><%= cart_item.quantity %></td>
                  <td><%= number_to_currency(cart_item.product.price) %></td>
                  <td><%= number_to_currency(cart_item.product.price * cart_item.quantity) %></td>
                </tr>
              <% end %>
            <% end %>
          <% end %>
        </tbody>
        <tfoot>
          <% if orders.any? && orders.first.cart.cart_items&.first&.product&.user %>
            <tr>
              <td colspan="3">Delivery Fee:</td>
              <td colspan="2"><%= number_to_currency(orders.first.cart.cart_items.first.product.user.delivery_fee || 0) %></td>
            </tr>
            <tr>
              <td colspan="3"><strong>Grand Total:</strong></td>
              <td colspan="2"><strong><%= number_to_currency(orders.sum { |o| o.cart.cart_items.sum { |item| item.product.price * item.quantity } } + (orders.first.cart.cart_items.first.product.user.delivery_fee || 0)) %></strong></td>
            </tr>
          <% end %>
        </tfoot>
      </table>
    <% end %>
  <% end %>
</div>
