<div class="container">
  <% if @user.photo.attached? %>
    <%= cl_image_tag url_for(current_user.photo), height: 300, width: 300, crop: :thumb %>
  <% else %>
    <%= image_tag 'default-foto.jpg',height: 300, width: 300, crop: :thumb %>
  <% end %>
  <% if @user.restaurant %>
    <h1>Profile</h1>
    <div id="restaurant-profile">
      <h2>
        <strong><%= @user.name %></strong>
      </h2>

      <p>
        <strong>Location:</strong>
        <%= @user.address %>
      </p>



    <%= link_to 'Edit', edit_user_registration_path(@user), class: 'btn btn-warning' %>
    <%= link_to "Back", root_path, class: "btn btn-secondary" %>
    </div>

    <h2 class="mt-4">Sales Made</h2>
    <% @user.products.each do |product| %>
      <% product.orders.group_by { |order| order.created_at.to_i }.each do |timestamp, orders| %>
        <h3>Order placed on: <%= l(Time.at(timestamp), format: :short) %></h3>
        <table class="table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Price</th>
              <th>Product Total</th>
            </tr>
          </thead>
          <tbody>
            <% orders.each do |order| %>
              <% if order.product.present? %>
                <tr>
                  <td><%= order.product.name %></td>
                  <td><%= order.quantity %></td>
                  <td><%= number_to_currency(order.price) %></td>
                  <td><%= number_to_currency(order.price * order.quantity) %></td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          <tfoot>
            <% if orders.any? && orders.first.product && orders.first.product.user %>
              <tr>
                <td colspan="3">Delivery Fee:</td>
                <td><%= number_to_currency(orders.first.product.user.delivery_fee || 0) %></td>
              </tr>
              <tr>
                <td colspan="3"><strong>Grand Total:</strong></td>
                <td><strong><%= number_to_currency(orders.sum { |o| o.price * o.quantity } + (orders.first.product.user.delivery_fee || 0)) %></strong></td>
              </tr>
            <% end %>
          </tfoot>
        </table>
      <% end %>
    <% end %>
  <% else %>
    <h1>User Profile</h1>
    <div id="user-profile">
      <h2>
        <strong>Name:</strong>
        <%= @user.name %>
      </h2>

      <p>
        <strong>Email:</strong>
        <%= @user.email %>
      </p>

    <%= link_to 'Edit', edit_user_registration_path(@user), class: 'btn btn-warning' %>
    <%= link_to "Back", root_path, class: "btn btn-secondary" %>
    </div>

    <h2 class="mt-4">Purchases Made</h2>
    <% @user.orders.group_by { |order| order.created_at.to_i }.each do |timestamp, orders| %>
      <h3>Order placed on: <%= l(Time.at(timestamp), format: :short) %></h3>
      <table class="table">
        <thead>
          <tr>
            <th>Product</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Product Total</th>
          </tr>
        </thead>
        <tbody>
          <% orders.each do |order| %>
            <% if order.product.present? %>
              <tr>
                <td><%= order.product.name %></td>
                <td><%= order.quantity %></td>
                <td><%= number_to_currency(order.price) %></td>
                <td><%= number_to_currency(order.price * order.quantity) %></td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
        <tfoot>
          <% if orders.any? && orders.first.product && orders.first.product.user %>
            <tr>
              <td colspan="3">Delivery Fee:</td>
              <td><%= number_to_currency(orders.first.product.user.delivery_fee || 0) %></td>
            </tr>
            <tr>
              <td colspan="3"><strong>Grand Total:</strong></td>
              <td><strong><%= number_to_currency(orders.sum { |o| o.price * o.quantity } + (orders.first.product.user.delivery_fee || 0)) %></strong></td>
            </tr>
          <% end %>
        </tfoot>
      </table>
    <% end %>
  <% end %>
</div>
